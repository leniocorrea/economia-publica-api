name: Deploy to Cloud Run with Database Setup

on:
  push:
      branches:
            - master

            env:
              PROJECT_ID: economia-publica-482719
                GKE_REGION: us-central1
                  SERVICE_NAME: economia-api
                    ARTIFACT_REGISTRY_REGION: us-central1
                      ARTIFACT_REGISTRY_REPO: economia-app

                      jobs:
                        setup-and-deploy:
                            runs-on: ubuntu-latest

                                    permissions:
                                          contents: read
                                                id-token: write

                                                    steps:
                                                          - name: Checkout code
                                                                  uses: actions/checkout@v4

                                                                        - name: Set up Cloud SDK
                                                                                uses: google-github-actions/setup-gcloud@v1
                                                                                        with:
                                                                                                  project_id: ${{ env.PROJECT_ID }}
                                                                                                            workload_identity_provider: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
                                                                                                                      service_account: ${{ secrets.SERVICE_ACCOUNT_EMAIL }}
                                                                                                                      
                                                                                                                            - name: Configure Docker to push to Artifact Registry
                                                                                                                                    run: |
                                                                                                                                              gcloud auth configure-docker ${{ env.ARTIFACT_REGISTRY_REGION }}-docker.pkg.dev
                                                                                                                                              
                                                                                                                                                    - name: Build Docker image
                                                                                                                                                            run: |
                                                                                                                                                                      docker build -t ${{ env.ARTIFACT_REGISTRY_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/economia-api:latest \
                                                                                                                                                                                  -t ${{ env.ARTIFACT_REGISTRY_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/economia-api:${{ github.sha }} .
                                                                                                                                                                                  
                                                                                                                                                                                        - name: Push Docker image to Artifact Registry
                                                                                                                                                                                                run: |
                                                                                                                                                                                                          docker push ${{ env.ARTIFACT_REGISTRY_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/economia-api:latest
                                                                                                                                                                                                                    docker push ${{ env.ARTIFACT_REGISTRY_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/economia-api:${{ github.sha }}
                                                                                                                                                                                                                    
                                                                                                                                                                                                                          - name: Check if first deployment
                                                                                                                                                                                                                                  id: first-deploy
                                                                                                                                                                                                                                          run: |
                                                                                                                                                                                                                                                    if gcloud run services describe ${{ env.SERVICE_NAME }} --region ${{ env.GKE_REGION }} 2>/dev/null; then
                                                                                                                                                                                                                                                                echo "first-deploy=false" >> $GITHUB_OUTPUT
                                                                                                                                                                                                                                                                          else
                                                                                                                                                                                                                                                                                      echo "first-deploy=true" >> $GITHUB_OUTPUT
                                                                                                                                                                                                                                                                                                fi
                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                      - name: Initialize PostgreSQL (First deployment only)
                                                                                                                                                                                                                                                                                                              if: steps.first-deploy.outputs.first-deploy == 'true'
                                                                                                                                                                                                                                                                                                                      run: bash ./scripts/setup-cloud-sql.sh
                                                                                                                                                                                                                                                                                                                              env:
                                                                                                                                                                                                                                                                                                                                        PROJECT_ID: ${{ env.PROJECT_ID }}
                                                                                                                                                                                                                                                                                                                                                  CLOUD_SQL_INSTANCE: ${{ secrets.CLOUD_SQL_INSTANCE }}
                                                                                                                                                                                                                                                                                                                                                            DB_NAME: economia_db
                                                                                                                                                                                                                                                                                                                                                                      DB_USER: ${{ secrets.DB_USER }}
                                                                                                                                                                                                                                                                                                                                                                                DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                      - name: Initialize Elasticsearch (First deployment only)
                                                                                                                                                                                                                                                                                                                                                                                              if: steps.first-deploy.outputs.first-deploy == 'true'
                                                                                                                                                                                                                                                                                                                                                                                                      run: bash ./scripts/setup-elasticsearch.sh
                                                                                                                                                                                                                                                                                                                                                                                                              env:
                                                                                                                                                                                                                                                                                                                                                                                                                        PROJECT_ID: ${{ env.PROJECT_ID }}
                                                                                                                                                                                                                                                                                                                                                                                                                                  ELASTICSEARCH_PASSWORD: ${{ secrets.ELASTICSEARCH_PASSWORD }}
                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                        - name: Deploy to Cloud Run
                                                                                                                                                                                                                                                                                                                                                                                                                                                run: |
                                                                                                                                                                                                                                                                                                                                                                                                                                                          gcloud run deploy ${{ env.SERVICE_NAME }} \
                                                                                                                                                                                                                                                                                                                                                                                                                                                                      --image=${{ env.ARTIFACT_REGISTRY_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/economia-api:latest \
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  --region=${{ env.GKE_REGION }} \
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              --allow-unauthenticated \
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          --service-account=${{ secrets.SERVICE_ACCOUNT_EMAIL }} \
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      --set-env-vars="ASPNETCORE_ENVIRONMENT=Production,DATABASE_HOST=${{ secrets.CLOUD_SQL_INSTANCE }},DATABASE_USER=${{ secrets.DB_USER }},DATABASE_PASSWORD=${{ secrets.DB_PASSWORD }},ELASTICSEARCH_HOST=${{ secrets.ELASTICSEARCH_HOST }},ELASTICSEARCH_PASSWORD=${{ secrets.ELASTICSEARCH_PASSWORD }}" \
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  --platform managed \
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              --memory=512Mi \
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          --cpu=1 \
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      --timeout=300 \
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  --max-instances=100 \
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              --min-instances=0
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    - name: Get service URL
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            run: |
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} --region ${{ env.GKE_REGION }} --format 'value(status.url)')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                echo "Service deployed at: $URL"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          echo "$URL" >> $GITHUB_STEP_SUMMARY
